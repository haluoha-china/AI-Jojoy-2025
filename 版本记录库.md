# 企业知识库环境版本记录库

## 📅 记录日期：2025年8月20日
## 🎯 目标：AutoDL平台企业知识库环境复现

---

## 🖥️ 系统环境版本

### 基础系统
| **组件** | **版本** | **说明** |
|----------|----------|----------|
| 操作系统 | Ubuntu 22.04 | 基础系统 |
| Python (base) | 3.12.3 | 系统默认Python |
| Python (kb_enterprise) | 3.12.3 | 知识库专用环境 |
| CUDA | 12.4 | NVIDIA驱动版本 |
| GPU | RTX 4090D | 24GB显存 |
| 内存 | 60GB | 系统内存 |
| 存储 | 系统盘30GB + 数据盘50GB | 存储配置 |

### conda环境
| **环境名称** | **Python版本** | **路径** | **用途** |
|-------------|----------------|----------|----------|
| base | 3.12.3 | `/root/miniconda3` | 基础环境 |
| kb_enterprise | 3.12.3 | `/root/autodl-tmp/enterprise_kb/conda/envs/kb_enterprise` | 知识库开发环境 |
| kb_prod | - | `/root/autodl-tmp/enterprise_kb/conda/envs/kb_prod` | 生产环境 |

---

## 🐍 Python包版本记录

### 深度学习核心
| **包名** | **版本** | **安装方式** | **CUDA支持** |
|----------|----------|--------------|--------------|
| torch | 2.3.0+cu121 | pip | ✅ CUDA 12.1 |
| torchvision | 0.18.0+cu121 | pip | ✅ CUDA 12.1 |
| torchaudio | 2.3.0+cu121 | pip | ✅ CUDA 12.1 |
| transformers | 4.38.2 | pip | ✅ |
| sentence-transformers | 2.6.0 | pip | ✅ |

### 向量数据库
| **包名** | **版本** | **安装方式** | **GPU支持** |
|----------|----------|--------------|-------------|
| faiss-gpu | 1.7.2 | pip | ✅ GPU加速 |
| numpy | 1.24.3 | conda | ✅ |

### 知识库框架
| **包名** | **版本** | **安装方式** | **说明** |
|----------|----------|--------------|----------|
| langchain | 0.1.14 | pip | 知识库框架 |
| langchain-community | 0.0.38 | pip | 社区组件 |
| langchain-core | 0.1.53 | pip | 核心组件 |
| langchain-text-splitters | 0.0.2 | pip | 文本分割器 |

### LoRA微调框架
| **包名** | **版本** | **安装方式** | **说明** |
|----------|----------|--------------|----------|
| LLaMA-Factory | 最新版 | git clone | 7B模型LoRA微调框架 |
| accelerate | 1.0.1 | pip | 分布式训练加速 |
| peft | 0.13.2 | pip | 参数高效微调 |
| trl | 0.11.4 | pip | 强化学习训练 |
| bitsandbytes | 0.45.5 | pip | 量化训练支持 |

### 文本处理
| **包名** | **版本** | **安装方式** | **说明** |
|----------|----------|--------------|----------|
| pdfminer.six | 20240706 | pip | PDF解析 |
| qwen-agent | 0.0.10 | pip | 千问Agent |
| dashscope | 1.24.2 | pip | 阿里云嵌入服务 |

### 视频处理
| **包名** | **版本** | **安装方式** | **说明** |
|----------|----------|--------------|----------|
| opencv-python-headless | 4.8.0.76 | pip | 图像/视频处理 |
| moviepy | 1.0.3 | pip | 视频编辑 |
| imageio | 2.31.1 | pip | 图像IO |
| imageio-ffmpeg | 0.5.1 | pip | FFmpeg绑定 |
| pillow | 9.5.0 | pip | 图像处理 |

### 音频处理
| **包名** | **版本** | **安装方式** | **说明** |
|----------|----------|--------------|----------|
| librosa | 0.10.0 | pip | 音频分析 |
| soundfile | 0.13.1 | pip | 音频文件处理 |
| audioread | 3.0.1 | pip | 音频读取 |
| numba | 0.58.1 | pip | JIT编译加速 |

### 系统工具
| **包名** | **版本** | **安装方式** | **说明** |
|----------|----------|--------------|----------|
| ffmpeg | 4.3 | apt | 视频编解码 |
| ffmpeg-python | - | pip | Python FFmpeg接口 |

### 依赖包
| **包名** | **版本** | **安装方式** | **说明** |
|----------|----------|--------------|----------|
| scipy | 1.10.1 | pip | 科学计算 |
| scikit-learn | 1.3.2 | pip | 机器学习 |
| tqdm | 4.67.1 | pip | 进度条 |
| requests | 2.32.3 | pip | HTTP请求 |
| pydantic | 2.10.6 | pip | 数据验证 |
| fastapi | - | pip | Web框架 |
| uvicorn | - | pip | ASGI服务器 |

---

## 📦 安装命令库

### 1. 环境准备
```bash
# 更新系统
apt update

# 安装基础工具
apt install -y ffmpeg
```

### 2. conda环境配置
```bash
# 初始化conda
conda init bash
source ~/.bashrc

# 创建知识库环境
conda create -n kb_enterprise python=3.12 -y
conda activate kb_enterprise
```

### 3. PyTorch安装
```bash
# 卸载旧版本
pip uninstall torch torchvision torchaudio -y

# 安装CUDA版本
pip install torch==2.3.0+cu121 torchvision==0.18.0+cu121 torchaudio==2.3.0+cu121 --index-url https://download.pytorch.org/whl/cu121
```

### 4. 核心依赖安装
```bash
# 向量数据库
pip install faiss-gpu==1.7.2

# 知识库框架
pip install langchain==0.1.14
pip install langchain-community==0.0.38
pip install langchain-core==0.1.53
pip install langchain-text-splitters==0.0.2

# 文本处理
pip install transformers==4.38.2
pip install sentence-transformers==2.6.0
pip install pdfminer.six==20240706
pip install qwen-agent==0.0.10
pip install dashscope==1.24.2
```

### 5. 视频处理安装
```bash
# 图像/视频处理
pip install opencv-python-headless==4.8.0.76
pip install moviepy==1.0.3
pip install imageio==2.31.1
pip install pillow==9.5.0

# 音频处理
pip install librosa==0.10.0
pip install soundfile==0.13.1
pip install audioread==3.0.1
pip install numba==0.58.1
```

### 6. 其他依赖
```bash
# 科学计算
pip install scipy==1.10.1
pip install scikit-learn==1.3.2

# 工具包
pip install tqdm==4.67.1
pip install requests==2.32.3
pip install pydantic==2.10.6
```

---

## 🔍 版本验证命令

### 基础环境验证
```bash
# Python版本
python --version

# conda环境
conda env list
conda list | head -20
```

### 核心包验证
```bash
# PyTorch验证
python -c "import torch; print(f'PyTorch: {torch.__version__}, CUDA: {torch.cuda.is_available()}')"

# FAISS验证
python -c "import faiss; print(f'FAISS-GPU: {faiss.__version__}, GPU数: {faiss.get_num_gpus()}')"

# LangChain验证
python -c "import langchain; print(f'LangChain: {langchain.__version__}')"

# LLaMA-Factory验证
python -c "import src; print('✅ LLaMA-Factory基础功能正常')"
```

### 视频处理验证
```bash
# OpenCV验证
python -c "import cv2; print(f'OpenCV: {cv2.__version__}')"

# FFmpeg验证
ffmpeg -version

# 完整测试
python test_video_env.py
```

---

## 📋 一键安装脚本

### 创建安装脚本
```bash
cat > install_enterprise_kb.sh << 'EOF'
#!/bin/bash

echo "🚀 开始安装企业知识库环境..."

# 更新系统
echo "📦 更新系统包..."
apt update -y
apt install -y ffmpeg

# 初始化conda
echo "🐍 配置conda环境..."
conda init bash
source ~/.bashrc

# 创建环境
echo "🏗️ 创建知识库环境..."
conda create -n kb_enterprise python=3.12 -y
conda activate kb_enterprise

# 安装PyTorch
echo "🔥 安装PyTorch..."
pip uninstall torch torchvision torchaudio -y
pip install torch==2.3.0+cu121 torchvision==0.18.0+cu121 torchaudio==2.3.0+cu121 --index-url https://download.pytorch.org/whl/cu121

# 安装核心依赖
echo "📚 安装核心依赖..."
pip install faiss-gpu==1.7.2
pip install langchain==0.1.14 langchain-community==0.0.38 langchain-core==0.1.53 langchain-text-splitters==0.0.2
pip install transformers==4.38.2 sentence-transformers==2.6.0 pdfminer.six==20240706 qwen-agent==0.0.10 dashscope==1.24.2

# 安装视频处理
echo "🎥 安装视频处理..."
pip install opencv-python-headless==4.8.0.76 moviepy==1.0.3 imageio==2.31.1 pillow==9.5.0

# 安装音频处理
echo "🎵 安装音频处理..."
pip install librosa==0.10.0 soundfile==0.13.1 audioread==3.0.1 numba==0.58.1

# 安装其他依赖
echo "🔧 安装其他依赖..."
pip install scipy==1.10.1 scikit-learn==1.3.2 tqdm==4.67.1 requests==2.32.3 pydantic==2.10.6

echo "✅ 安装完成！"
echo "🔍 请运行验证命令检查环境..."
EOF

chmod +x install_enterprise_kb.sh
```

### 创建LLaMA-Factory安装脚本
```bash
cat > install_llama_factory.sh << 'EOF'
#!/bin/bash

echo "🤖 开始安装LLaMA-Factory微调框架..."

# 激活conda环境
source ~/miniconda3/etc/profile.d/conda.sh
conda activate kb_enterprise

# 切换到数据盘
cd /root/autodl-tmp/enterprise_kb

# 克隆LLaMA-Factory
echo "📥 克隆LLaMA-Factory仓库..."
git clone https://github.com/hiyouga/LLaMA-Factory.git
cd LLaMA-Factory

# 安装核心依赖（跳过版本冲突）
echo "📦 安装核心依赖..."
pip install \
    accelerate \
    datasets \
    peft \
    trl \
    bitsandbytes \
    scipy \
    scikit-learn \
    matplotlib \
    seaborn \
    pandas \
    numpy \
    tqdm \
    wandb \
    tensorboard \
    --index-url https://pypi.tuna.tsinghua.edu.cn/simple

# 准备训练数据
echo "📚 准备训练数据..."
mkdir -p data
cat > data/enterprise_kb.jsonl <<EOF
{"instruction":"ESS培训每月几次？","input":"","output":"根据《ESS培训管理制度》规定，ESS培训每月进行3次，分别在每月第一周、第三周和第五周进行。具体时间安排请查看公司内网培训日历。"}
{"instruction":"打印机出现数据库连接失败怎么办？","input":"","output":"当打印机出现数据库连接失败时，请按以下步骤处理：1. 检查MSSQLSERVER服务是否启动；2. 确认1433端口是否放行；3. 检查网络连接；4. 重启打印服务。详细操作步骤请参考《IT故障处理手册》第12页。"}
{"instruction":"什么是ESS系统？","input":"","output":"ESS（Employee Self Service）是员工自助服务系统，员工可以通过该系统进行请假申请、加班申请、考勤查询、薪资查询等操作。系统访问地址：http://ess.company.com"}
{"instruction":"公司内部简称解释","input":"","output":"公司内部常用简称包括：ESS（员工自助服务）、OA（办公自动化）、ERP（企业资源规划）、CRM（客户关系管理）、HR（人力资源）、IT（信息技术）、QA（质量保证）、QC（质量控制）等。"}
{"instruction":"如何申请年假？","input":"","output":"年假申请流程：1. 登录ESS系统；2. 选择'请假申请'；3. 填写请假类型为'年假'；4. 选择开始和结束时间；5. 填写请假事由；6. 提交申请等待审批。详细操作步骤请参考《ESS系统使用手册》。"}
EOF

# 创建训练配置
echo "⚙️ 创建训练配置..."
mkdir -p configs
cat > configs/enterprise_kb_lora.yaml <<EOF
# 企业知识库LoRA微调配置
model_name_or_path: deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
dataset_path: data/enterprise_kb.jsonl
template: qwen
finetuning_type: lora
output_dir: ./lora_ckpt
per_device_train_batch_size: 4
gradient_accumulation_steps: 4
num_train_epochs: 3
quantization_bit: 4
learning_rate: 3e-4
fp16: true
lora_rank: 8
lora_alpha: 16
lora_dropout: 0.1
EOF

echo "✅ LLaMA-Factory安装完成！"
echo "📁 位置: /root/autodl-tmp/enterprise_kb/LLaMA-Factory/"
echo "🔍 验证命令: python -c 'import src; print(\"✅ LLaMA-Factory基础功能正常\")'"
EOF

chmod +x install_llama_factory.sh
```

### 运行安装脚本
```bash
# 安装基础环境
./install_enterprise_kb.sh

# 安装LLaMA-Factory
./install_llama_factory.sh
```

---

## ⚠️ 注意事项

### 版本兼容性
1. **Python版本**: 使用Python 3.12，兼容性更好
2. **CUDA版本**: 确保CUDA 12.1+兼容性
3. **包依赖**: 严格按照版本号安装，避免自动升级

### 安装顺序
1. 先安装系统工具（FFmpeg）
2. 再安装PyTorch（CUDA版本）
3. 然后安装FAISS-GPU
4. 最后安装其他依赖包

### 环境隔离
- 始终使用`kb_enterprise`环境
- 避免在base环境中安装包
- 定期备份环境配置

---

## 🔄 环境复现步骤

### 完整复现流程
1. **准备AutoDL实例**
   - Ubuntu 22.04
   - RTX 4090D + CUDA 12.1+
   - 至少60GB内存

2. **运行安装脚本**
   ```bash
   ./install_enterprise_kb.sh
   ```

3. **验证环境**
   ```bash
   conda activate kb_enterprise
   python -c "import torch, faiss, langchain; print('环境就绪！')"
   ```

4. **测试功能**
   ```bash
   python test_video_env.py
   ```

---

## 📊 版本兼容性矩阵

| **组件** | **最低版本** | **推荐版本** | **最高版本** | **说明** |
|----------|--------------|--------------|--------------|----------|
| Python | 3.8 | 3.12 | 3.12 | Python 3.12兼容性最佳 |
| PyTorch | 2.0.0 | 2.3.0+cu121 | 2.4.0 | CUDA 12.1支持 |
| FAISS | 1.7.0 | 1.7.2 | 1.8.0 | GPU加速必需 |
| LangChain | 0.1.0 | 0.1.14 | 0.2.0 | 避免0.2.0破坏性更新 |
| OpenCV | 4.8.0 | 4.8.0.76 | 4.9.0 | 稳定性优先 |
| LLaMA-Factory | 最新版 | 最新版 | 最新版 | 7B模型LoRA微调 |
| accelerate | 0.20.0 | 1.0.1 | 1.1.0 | 分布式训练加速 |
| peft | 0.10.0 | 0.13.2 | 0.14.0 | 参数高效微调 |
| trl | 0.10.0 | 0.11.4 | 0.12.0 | 强化学习训练 |
| bitsandbytes | 0.40.0 | 0.45.5 | 0.46.0 | 量化训练支持 |

---

## 🏆 总结

这个版本记录库包含了：
- ✅ **精确版本号**: 所有包的精确版本
- ✅ **安装命令**: 完整的安装步骤
- ✅ **验证方法**: 环境验证命令
- ✅ **一键脚本**: 自动化安装脚本
- ✅ **兼容性信息**: 版本兼容性矩阵
- ✅ **LoRA微调**: LLaMA-Factory微调框架
- ✅ **7B模型支持**: 支持DeepSeek-R1-7B等大模型微调

### 🎯 新增功能亮点

#### LLaMA-Factory微调框架
- **功能**: 7B模型LoRA微调
- **位置**: 数据盘存储，避免系统盘空间占用
- **训练数据**: 企业知识库Q&A样本
- **配置**: 完整的LoRA训练参数配置
- **验证**: 基础功能测试通过

#### 环境优化
- **存储策略**: 系统盘30GB + 数据盘50GB
- **依赖管理**: 跳过版本冲突，手动安装核心包
- **空间管理**: 大型模型和训练数据存储在数据盘

**使用建议**：
1. 严格按照版本号安装
2. 使用提供的安装脚本
3. 安装完成后立即验证
4. 保存此文档用于环境复现

现在你可以随时按照这个版本记录库来复现完全相同的企业知识库环境！🚀

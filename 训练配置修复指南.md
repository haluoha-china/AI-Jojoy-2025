# 🚀 训练配置修复指南

## 🔍 问题诊断

根据kimi的建议和代码检查，你的训练配置存在以下问题：

### ❌ **主要问题**
1. **数据集配置不匹配**: 训练命令中使用的数据集名称与实际的 `dataset_info.json` 配置不一致
2. **文件路径错误**: 训练脚本检查的是 `train_data_final.jsonl` 和 `eval_data_final.jsonl`，但实际文件名可能是 `comprehensive_eval.jsonl`
3. **缺少正确的 `dataset_info.json` 配置**

## ✅ **修复步骤**

### 步骤1: 准备训练数据文件

```bash
# 进入项目目录
cd /root/autodl-tmp/enterprise_kb/LLaMA-Factory

# 运行数据准备脚本
python prepare_training_files.py
```

这个脚本会：
- 读取现有的 `comprehensive_eval.jsonl` 文件
- 将其分割为训练集和验证集
- 创建正确的 `dataset_info.json` 配置文件

### 步骤2: 验证数据文件

```bash
# 检查生成的文件
ls -la train_data_final.jsonl eval_data_final.jsonl
ls -la data/dataset_info.json

# 查看数据统计
wc -l train_data_final.jsonl eval_data_final.jsonl
```

### 步骤3: 清理输出目录

```bash
# 清理之前的训练输出
rm -rf ./lora_ckpt_prod
```

### 步骤4: 运行正确的训练命令

```bash
python src/train.py \
  --model_name_or_path /root/autodl-tmp/enterprise_kb/models/transformers/DeepSeek-R1-Distill-Qwen-7B \
  --dataset company_abbreviations_train \
  --eval_dataset company_abbreviations_eval \
  --template qwen \
  --finetuning_type lora \
  --lora_rank 8 \
  --lora_alpha 16 \
  --lora_dropout 0.1 \
  --lora_target q_proj,v_proj \
  --output_dir ./lora_ckpt_prod \
  --num_train_epochs 2 \
  --per_device_train_batch_size 1 \
  --gradient_accumulation_steps 16 \
  --learning_rate 5e-5 \
  --cutoff_len 256 \
  --save_strategy steps \
  --save_steps 100 \
  --logging_steps 1 \
  --overwrite_output_dir \
  --bf16 true \
  --metric_for_best_model eval_loss \
  --load_best_model_at_end true
```

## 🔑 **关键配置说明**

### ✅ **正确的数据集名称**
- **`--dataset company_abbreviations_train`**: 对应 `dataset_info.json` 中的键名，不是文件名
- **`--eval_dataset company_abbreviations_eval`**: 对应 `dataset_info.json` 中的键名，不是文件名

### ✅ **文件映射关系**
```json
{
  "company_abbreviations_train": {
    "file_name": "train_data_final.jsonl",  // 实际文件名
    "columns": { ... }
  },
  "company_abbreviations_eval": {
    "file_name": "eval_data_final.jsonl",   // 实际文件名
    "columns": { ... }
  }
}
```

## 🚨 **常见错误避免**

### ❌ **错误用法**
```bash
--dataset train_data_final.jsonl        # 错误：这是文件名
--dataset "train_data_final.jsonl"      # 错误：这是文件名
```

### ✅ **正确用法**
```bash
--dataset company_abbreviations_train    # 正确：这是dataset_info.json中的键名
--eval_dataset company_abbreviations_eval # 正确：这是dataset_info.json中的键名
```

## 📋 **快速检查清单**

- [ ] 运行 `python prepare_training_files.py` 生成训练数据
- [ ] 确认 `train_data_final.jsonl` 和 `eval_data_final.jsonl` 文件存在
- [ ] 确认 `data/dataset_info.json` 配置文件存在
- [ ] 清理输出目录 `rm -rf ./lora_ckpt_prod`
- [ ] 使用正确的数据集名称运行训练命令

## 🎯 **预期结果**

修复完成后，训练应该能够正常启动，并且：
- 训练集和验证集正确加载
- 模型开始正常训练
- 检查点正常保存
- 评估指标正常计算

## 🆘 **如果仍有问题**

如果按照以上步骤仍然有问题，请检查：
1. 文件权限是否正确
2. Python环境是否激活
3. LLaMA-Factory是否正确安装
4. 模型路径是否正确

运行以下命令获取更多诊断信息：
```bash
python prepare_training_files.py
cat data/dataset_info.json
ls -la *.jsonl
```

# 📚 样本数据配置指南

## 📋 概述

本指南专门针对你的样本数据进行配置，包括：
1. **Q&A 文档**：包含问题和答案的文档
2. **内部简称文档**：定义公司内部简称的基础概念文档  
3. **视频文件**：需要多模态处理的视频内容

## 🎯 样本数据特点分析

### 1. Q&A 文档
- **内容类型**：问题和答案对
- **应用场景**：员工培训、制度查询、流程指导
- **处理方式**：LoRA微调训练数据

### 2. 内部简称文档
- **内容类型**：缩写词解释和定义
- **应用场景**：新员工入职、跨部门沟通
- **处理方式**：知识图谱构建、快速检索

### 3. 视频文件
- **内容类型**：培训视频、操作演示、会议记录
- **应用场景**：技能培训、流程演示、知识传播
- **处理方式**：多模态模型处理、关键帧提取

## 🚀 配置步骤

### 第一步：准备LoRA训练数据

#### 1.1 创建企业Q&A训练数据

```bash
cd ~/LLaMA-Factory
nano data/enterprise_qa.jsonl
```

**数据格式示例**（请根据你的实际文档调整）：

```json
{"instruction":"ESS培训每月几次？","input":"","output":"根据《ESS培训管理制度》规定，ESS培训每月进行3次，分别在每月第一周、第三周和第五周进行。具体时间安排请查看公司内网培训日历。"}
{"instruction":"打印机出现数据库连接失败怎么办？","input":"","output":"当打印机出现数据库连接失败时，请按以下步骤处理：1. 检查MSSQLSERVER服务是否启动；2. 确认1433端口是否放行；3. 检查网络连接；4. 重启打印服务。详细操作步骤请参考《IT故障处理手册》第12页。"}
{"instruction":"什么是ESS系统？","input":"","output":"ESS（Employee Self Service）是员工自助服务系统，员工可以通过该系统进行请假申请、加班申请、考勤查询、薪资查询等操作。系统访问地址：http://ess.company.com"}
{"instruction":"如何申请年假？","input":"","output":"年假申请流程：1. 登录ESS系统；2. 选择'请假申请'；3. 填写请假类型为'年假'；4. 选择开始和结束时间；5. 填写请假事由；6. 提交申请等待审批。详细操作步骤请参考《ESS系统使用手册》。"}
{"instruction":"公司内部简称解释","input":"","output":"公司内部常用简称包括：ESS（员工自助服务）、OA（办公自动化）、ERP（企业资源规划）、CRM（客户关系管理）、HR（人力资源）、IT（信息技术）、QA（质量保证）、QC（质量控制）等。"}
```

#### 1.2 创建内部简称概念库

```bash
nano data/company_abbreviations.jsonl
```

**简称文档格式示例**：

```json
{"instruction":"什么是ESS？","input":"","output":"ESS是Employee Self Service的缩写，中文名称：员工自助服务系统。功能包括：请假申请、加班申请、考勤查询、薪资查询、个人信息维护等。"}
{"instruction":"什么是OA？","input":"","output":"OA是Office Automation的缩写，中文名称：办公自动化系统。主要功能：文档管理、流程审批、会议安排、公告发布等。"}
{"instruction":"什么是ERP？","input":"","output":"ERP是Enterprise Resource Planning的缩写，中文名称：企业资源规划系统。涵盖：财务、采购、销售、库存、生产等业务流程管理。"}
{"instruction":"什么是CRM？","input":"","output":"CRM是Customer Relationship Management的缩写，中文名称：客户关系管理系统。功能包括：客户信息管理、销售机会跟踪、合同管理等。"}
{"instruction":"什么是HR？","input":"","output":"HR是Human Resources的缩写，中文名称：人力资源。负责：招聘、培训、绩效考核、薪酬福利、员工关系等。"}
{"instruction":"什么是IT？","input":"","output":"IT是Information Technology的缩写，中文名称：信息技术。负责：系统维护、网络管理、技术支持、数据安全等。"}
{"instruction":"什么是QA？","input":"","output":"QA是Quality Assurance的缩写，中文名称：质量保证。负责：质量标准制定、质量检查、质量改进等。"}
{"instruction":"什么是QC？","input":"","output":"QC是Quality Control的缩写，中文名称：质量控制。负责：产品质量检查、不合格品处理、质量数据统计等。"}
```

#### 1.3 合并训练数据

```bash
# 合并所有训练数据
cat data/enterprise_qa.jsonl data/company_abbreviations.jsonl > data/enterprise_kb_combined.jsonl

# 检查数据行数
wc -l data/enterprise_kb_combined.jsonl
```

### 第二步：配置多模态处理

#### 2.1 视频文件处理配置

在 `core/multimodal_processor.py` 中添加视频处理逻辑：

```python
def _process_video(self, content: str) -> Dict[str, Any]:
    """处理视频内容"""
    try:
        # 这里可以集成视频理解模型
        # 例如：MiniCPM-V、Video-LLaMA等
        
        # 视频处理步骤：
        # 1. 关键帧提取
        # 2. 场景识别
        # 3. 内容摘要生成
        # 4. 关键信息提取
        
        return {
            "type": "video",
            "content": content,
            "analysis": "视频内容分析结果",
            "key_frames": ["frame1.jpg", "frame2.jpg"],
            "summary": "视频内容摘要",
            "key_points": ["关键点1", "关键点2"],
            "status": "processed"
        }
        
    except Exception as e:
        logger.error(f"视频处理失败: {e}")
        raise
```

#### 2.2 图像处理配置

```python
def _process_image(self, content: str) -> Dict[str, Any]:
    """处理图像内容"""
    try:
        # 图像处理步骤：
        # 1. OCR文字识别
        # 2. 表格结构识别
        # 3. 图像内容理解
        # 4. 关键信息提取
        
        return {
            "type": "image",
            "content": content,
            "ocr_text": "识别出的文字内容",
            "table_data": "表格数据",
            "analysis": "图像内容分析结果",
            "status": "processed"
        }
        
    except Exception as e:
        logger.error(f"图像处理失败: {e}")
        raise
```

### 第三步：配置知识图谱规则

#### 3.1 简称关联规则

在千问Agent的Function Call配置中添加智能关联：

```json
{
  "name": "search_knowledge_base",
  "description": "搜索企业知识库，支持简称查询、流程查询、制度查询等，自动关联相关概念",
  "parameters": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "搜索查询内容，支持：1. 简称查询（如ESS、OA等）；2. 流程查询（如年假申请）；3. 制度查询（如培训制度）。系统会自动关联相关的简称、流程、制度等。"
      },
      "top_k": {
        "type": "integer",
        "description": "返回结果数量，默认5"
      },
      "include_related": {
        "type": "boolean",
        "description": "是否包含相关概念，默认true"
      }
    },
    "required": ["query"]
  }
}
```

#### 3.2 智能推荐规则

```python
def get_related_concepts(self, query: str) -> List[str]:
    """获取相关概念"""
    related = []
    
    # 简称关联
    if "ESS" in query.upper():
        related.extend(["员工自助服务", "请假申请", "考勤查询", "培训管理"])
    
    if "OA" in query.upper():
        related.extend(["办公自动化", "流程审批", "文档管理", "会议安排"])
    
    if "ERP" in query.upper():
        related.extend(["企业资源规划", "财务", "采购", "销售", "库存"])
    
    # 流程关联
    if "年假" in query or "请假" in query:
        related.extend(["ESS系统", "审批流程", "考勤制度", "假期管理"])
    
    if "培训" in query:
        related.extend(["培训制度", "培训计划", "培训记录", "培训评估"])
    
    return related
```

### 第四步：优化搜索策略

#### 4.1 多维度搜索

```python
def search(self, query: str, top_k: int = 5) -> List[Dict[str, Any]]:
    """多维度搜索知识库"""
    try:
        # 1. 精确匹配搜索
        exact_results = self._exact_search(query)
        
        # 2. 语义相似度搜索
        semantic_results = self._semantic_search(query)
        
        # 3. 相关概念搜索
        related_results = self._related_search(query)
        
        # 4. 多模态内容搜索
        multimodal_results = self._multimodal_search(query)
        
        # 5. 结果融合和排序
        combined_results = self._merge_results(
            exact_results, semantic_results, 
            related_results, multimodal_results
        )
        
        return combined_results[:top_k]
        
    except Exception as e:
        logger.error(f"搜索失败: {e}")
        raise
```

#### 4.2 智能排序

```python
def _merge_results(self, *result_lists):
    """智能融合搜索结果"""
    all_results = []
    
    # 收集所有结果
    for results in result_lists:
        all_results.extend(results)
    
    # 去重
    unique_results = self._deduplicate(all_results)
    
    # 智能排序
    sorted_results = sorted(
        unique_results,
        key=lambda x: self._calculate_relevance_score(x),
        reverse=True
    )
    
    return sorted_results

def _calculate_relevance_score(self, result):
    """计算相关性得分"""
    score = 0
    
    # 精确匹配加分
    if result.get("exact_match"):
        score += 10
    
    # 语义相似度加分
    score += result.get("semantic_score", 0) * 5
    
    # 相关概念加分
    if result.get("related_concepts"):
        score += 3
    
    # 多模态内容加分
    if result.get("multimodal"):
        score += 2
    
    return score
```

## 🧪 测试配置

### 1. 基础功能测试

测试以下典型问题：

```bash
# 简称查询测试
"什么是ESS？"
"OA系统有哪些功能？"
"ERP和CRM的区别是什么？"

# 流程查询测试
"如何申请年假？"
"ESS培训的流程是什么？"
"打印机故障怎么处理？"

# 制度查询测试
"公司年假制度是什么？"
"培训管理制度有哪些要求？"
"IT支持流程是什么？"
```

### 2. 多模态内容测试

#### 2.1 表格文档测试
- 上传包含表格的文档
- 测试表格数据提取
- 验证结构化展示

#### 2.2 图片文档测试
- 上传包含图片的文档
- 测试图片内容识别
- 验证图文关联

#### 2.3 视频文件测试
- 上传视频文件
- 测试视频内容提取
- 验证视频摘要生成

### 3. LoRA微调测试

```bash
# 检查训练环境
cd ~/LLaMA-Factory
source ~/enterprise_kb_env/bin/activate

# 检查CUDA可用性
python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"

# 开始微调
python src/train_bash.py \
  --stage sft \
  --model_name_or_path deepseek-ai/DeepSeek-R1-Distill-Qwen-7B \
  --dataset enterprise_kb_combined \
  --template qwen \
  --finetuning_type lora \
  --output_dir ./lora_ckpt \
  --per_device_train_batch_size 4 \
  --gradient_accumulation_steps 4 \
  --num_train_epochs 3 \
  --quantization_bit 4 \
  --learning_rate 3e-4 \
  --fp16
```

## 🔧 针对你的数据的优化建议

### 1. 数据质量优化

#### Q&A 文档优化
- 确保问题和答案的对应关系清晰
- 添加更多实际工作场景的问题
- 包含常见错误和解决方案
- 添加问题分类标签

#### 简称文档优化
- 按部门分类整理
- 添加使用频率标记
- 包含相关制度和流程链接
- 添加英文全称对照

#### 视频内容优化
- 添加视频标签和分类
- 生成关键帧截图
- 创建视频内容索引
- 添加时间戳标记

### 2. 模型性能优化

#### LoRA 微调优化
- 增加训练轮数（建议3-5轮）
- 调整学习率（建议2e-4到5e-4）
- 添加更多样本数据
- 使用数据增强技术

#### 向量检索优化
- 调整相似度阈值（建议0.7-0.8）
- 优化检索数量（建议top-5到top-10）
- 启用重排序功能
- 添加缓存机制

### 3. 用户体验优化

#### 智能推荐
- 基于用户查询历史推荐相关问题
- 提供相关概念链接
- 显示相关文档和视频
- 智能补全搜索关键词

#### 结果展示
- 结构化展示搜索结果
- 高亮显示关键信息
- 提供相关文档链接
- 支持结果导出

## 📊 性能监控指标

### 1. 搜索性能
- 搜索响应时间
- 搜索结果准确率
- 用户满意度评分
- 搜索成功率

### 2. 多模态处理
- 文档解析成功率
- 图像识别准确率
- 视频处理速度
- 多模态内容覆盖率

### 3. LoRA微调
- 训练收敛速度
- 模型性能提升
- 推理响应时间
- 内存使用情况

## 🎯 预期效果

配置完成后，你的企业知识库将能够：

✅ **智能问答**：准确回答关于公司制度、流程、简称等问题
✅ **多模态理解**：处理文档、表格、图片、视频等多种格式
✅ **知识关联**：自动关联相关的制度、流程、文档
✅ **个性化回答**：基于LoRA微调，提供符合公司文化的回答
✅ **持续学习**：根据用户反馈不断优化回答质量
✅ **智能推荐**：主动推荐相关的问题和答案

## 🚀 下一步行动

1. **立即开始**：按照本指南配置你的样本数据
2. **测试功能**：验证各项功能是否正常工作
3. **优化调整**：根据实际使用情况优化配置
4. **扩展功能**：添加更多企业数据和功能
5. **部署上线**：正式投入使用

## 🎉 完成！

恭喜！你已经完成了针对样本数据的专门配置！

现在你的企业知识库系统能够：
- 🎯 智能处理你的Q&A文档
- 🔤 准确理解公司内部简称
- 🎥 高效处理视频文件
- 🤖 提供个性化的智能问答服务

享受你的企业知识库之旅！🚀

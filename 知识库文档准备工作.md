# 知识库文档准备工作指南

## 📅 创建日期：2025年8月21日

### 🎯 目标
在7B模型下载期间，充分利用时间进行知识库文档的预处理工作，为后续的LoRA微调和知识库构建做好准备。

---

## �� 文档格式支持分析

### ✅ 完全支持的格式
- **PDF**: `PyMuPDF` + `pdfminer.six` ✅
- **TXT**: 原生支持 ✅
- **Word (.docx)**: `python-docx` ✅
- **Excel (.xlsx)**: `openpyxl` + `pandas` ✅
- **PowerPoint (.pptx)**: `python-pptx` ✅

### ⚠️ 需要安装的库
```bash
# 在模型下载的同时安装这些库
pip install python-docx openpyxl python-pptx pandas
```

---

## �� 文档检查与分类工作

### **1. 文档结构分析脚本**

#### 创建分析脚本
```bash
# 创建文档分析脚本
cat > analyze_docs.py << 'EOF'
#!/usr/bin/env python3
import os
import pandas as pd
from pathlib import Path
import json

def analyze_documents(docs_dir):
    """分析文档目录结构"""
    results = {
        'total_files': 0,
        'by_type': {},
        'by_size': {'small': 0, 'medium': 0, 'large': 0},
        'file_details': []
    }
    
    for file_path in Path(docs_dir).rglob('*'):
        if file_path.is_file():
            size_mb = file_path.stat().st_size / (1024 * 1024)
            ext = file_path.suffix.lower()
            
            # 统计文件类型
            if ext not in results['by_type']:
                results['by_type'][ext] = 0
            results['by_type'][ext] += 1
            
            # 按大小分类
            if size_mb < 1:
                size_cat = 'small'
            elif size_mb < 10:
                size_cat = 'medium'
            else:
                size_cat = 'large'
            results['by_size'][size_cat] += 1
            
            # 文件详情
            results['file_details'].append({
                'name': file_path.name,
                'path': str(file_path),
                'size_mb': round(size_mb, 2),
                'type': ext
            })
            
            results['total_files'] += 1
    
    return results

if __name__ == "__main__":
    docs_dir = "/root/autodl-tmp/enterprise_kb/sample_docs"
    
    if os.path.exists(docs_dir):
        results = analyze_documents(docs_dir)
        
        print("="*60)
        print(" 文档结构分析报告")
        print("="*60)
        print(f"📁 总文件数: {results['total_files']}")
        print()
        
        print(" 按文件类型统计:")
        for ext, count in results['by_type'].items():
            print(f"   {ext}: {count} 个文件")
        print()
        
        print(" 按文件大小统计:")
        print(f"   小文件 (<1MB): {results['by_size']['small']} 个")
        print(f"   中等文件 (1-10MB): {results['by_size']['medium']} 个")
        print(f"   大文件 (>10MB): {results['by_size']['large']} 个")
        print()
        
        print("📋 文件详情:")
        for file_info in results['file_details']:
            print(f"   {file_info['name']} ({file_info['size_mb']}MB) - {file_info['type']}")
        
        # 保存分析结果
        with open('/root/autodl-tmp/enterprise_kb/docs_analysis.json', 'w', encoding='utf-8') as f:
            json.dump(results, f, ensure_ascii=False, indent=2)
        
        print(f"\n💾 分析结果已保存到: docs_analysis.json")
    else:
        print(f"❌ 文档目录不存在: {docs_dir}")
EOF
```

#### 运行文档分析
```bash
# 运行文档分析
python analyze_docs.py
```

### **2. 文档分类整理脚本**

#### 创建整理脚本
```bash
# 创建文档分类脚本
cat > organize_docs.py << 'EOF'
#!/usr/bin/env python3
import os
import shutil
from pathlib import Path
import json

def organize_documents(docs_dir, output_dir):
    """按类型整理文档"""
    # 创建分类目录
    categories = {
        '.pdf': 'pdf_documents',
        '.docx': 'word_documents', 
        '.doc': 'word_documents',
        '.xlsx': 'excel_documents',
        '.xls': 'excel_documents',
        '.pptx': 'powerpoint_documents',
        '.ppt': 'powerpoint_documents',
        '.txt': 'text_documents',
        '.md': 'markdown_documents'
    }
    
    # 创建输出目录
    for category in set(categories.values()):
        os.makedirs(os.path.join(output_dir, category), exist_ok=True)
    
    # 移动文件
    moved_files = []
    for file_path in Path(docs_dir).rglob('*'):
        if file_path.is_file():
            ext = file_path.suffix.lower()
            if ext in categories:
                category = categories[ext]
                dest_dir = os.path.join(output_dir, category)
                dest_path = os.path.join(dest_dir, file_path.name)
                
                # 处理重名文件
                counter = 1
                while os.path.exists(dest_path):
                    name, ext_name = os.path.splitext(file_path.name)
                    dest_path = os.path.join(dest_dir, f"{name}_{counter}{ext_name}")
                    counter += 1
                
                shutil.copy2(file_path, dest_path)
                moved_files.append({
                    'original': str(file_path),
                    'organized': dest_path,
                    'category': category
                })
    
    return moved_files

if __name__ == "__main__":
    docs_dir = "/root/autodl-tmp/enterprise_kb/sample_docs"
    output_dir = "/root/autodl-tmp/enterprise_kb/organized_docs"
    
    if os.path.exists(docs_dir):
        print("🔄 开始整理文档...")
        moved_files = organize_documents(docs_dir, output_dir)
        
        print(f"✅ 文档整理完成！共处理 {len(moved_files)} 个文件")
        print(f" 整理后目录: {output_dir}")
        
        # 保存整理记录
        with open('/root/autodl-tmp/enterprise_kb/docs_organization.json', 'w', encoding='utf-8') as f:
            json.dump(moved_files, f, ensure_ascii=False, indent=2)
        
        print(f"💾 整理记录已保存到: docs_organization.json")
    else:
        print(f"❌ 文档目录不存在: {docs_dir}")
EOF
```

#### 运行文档整理
```bash
# 运行文档整理
python organize_docs.py
```

---

## �� 文档预处理工作

### **3. 创建多格式文档加载器**

#### 创建加载器脚本
```bash
# 创建多格式文档加载器
cat > document_loader.py << 'EOF'
#!/usr/bin/env python3
import os
from pathlib import Path
import fitz  # PyMuPDF
from docx import Document
import pandas as pd
from pptx import Presentation

class MultiFormatDocumentLoader:
    """多格式文档加载器"""
    
    def __init__(self):
        self.supported_formats = {
            '.pdf': self._load_pdf,
            '.docx': self._load_docx,
            '.xlsx': self._load_excel,
            '.pptx': self._load_pptx,
            '.txt': self._load_txt
        }
    
    def _load_pdf(self, file_path):
        """加载PDF文档"""
        try:
            doc = fitz.open(file_path)
            text = ""
            for page in doc:
                text += page.get_text()
            doc.close()
            return text
        except Exception as e:
            return f"PDF加载错误: {str(e)}"
    
    def _load_docx(self, file_path):
        """加载Word文档"""
        try:
            doc = Document(file_path)
            text = ""
            for paragraph in doc.paragraphs:
                text += paragraph.text + "\n"
            return text
        except Exception as e:
            return f"Word加载错误: {str(e)}"
    
    def _load_excel(self, file_path):
        """加载Excel文档"""
        try:
            df = pd.read_excel(file_path)
            # 转换为文本格式
            text = df.to_string(index=False)
            return text
        except Exception as e:
            return f"Excel加载错误: {str(e)}"
    
    def _load_pptx(self, file_path):
        """加载PowerPoint文档"""
        try:
            prs = Presentation(file_path)
            text = ""
            for slide in prs.slides:
                for shape in slide.shapes:
                    if hasattr(shape, "text"):
                        text += shape.text + "\n"
            return text
        except Exception as e:
            return f"PowerPoint加载错误: {str(e)}"
    
    def _load_txt(self, file_path):
        """加载文本文件"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                return f.read()
        except Exception as e:
            return f"文本加载错误: {str(e)}"
    
    def load_document(self, file_path):
        """加载文档"""
        file_path = Path(file_path)
        ext = file_path.suffix.lower()
        
        if ext in self.supported_formats:
            return self.supported_formats[ext](file_path)
        else:
            return f"不支持的文件格式: {ext}"
    
    def batch_load(self, directory):
        """批量加载文档"""
        results = {}
        for file_path in Path(directory).rglob('*'):
            if file_path.is_file():
                ext = file_path.suffix.lower()
                if ext in self.supported_formats:
                    print(f"📖 加载文档: {file_path.name}")
                    content = self.load_document(file_path)
                    results[str(file_path)] = {
                        'content': content[:500] + "..." if len(content) > 500 else content,
                        'length': len(content),
                        'type': ext
                    }
        return results

if __name__ == "__main__":
    loader = MultiFormatDocumentLoader()
    
    # 测试单个文件加载
    test_file = "/root/autodl-tmp/enterprise_kb/sample_docs/test.txt"
    if os.path.exists(test_file):
        content = loader.load_document(test_file)
        print(f" 测试文件内容预览: {content[:200]}...")
    
    # 批量加载测试
    docs_dir = "/root/autodl-tmp/enterprise_kb/sample_docs"
    if os.path.exists(docs_dir):
        print("\n🔄 开始批量加载文档...")
        results = loader.batch_load(docs_dir)
        
        print(f"\n✅ 批量加载完成！共处理 {len(results)} 个文档")
        for file_path, info in results.items():
            print(f"   {Path(file_path).name}: {info['type']} ({info['length']} 字符)")
EOF
```

#### 运行文档加载器测试
```bash
# 运行文档加载器测试
python document_loader.py
```

---

## 🚀 并行工作建议

### **在模型下载的同时，您可以：**

1. ** 文档分析** (30分钟)
   - 分析现有文档结构
   - 统计文件类型和大小
   - 识别需要特殊处理的文档

2. **️ 文档整理** (1小时)
   - 按类型分类文档
   - 创建标准目录结构
   - 处理重名文件

3. ** 环境准备** (30分钟)
   - 安装额外的文档处理库
   - 测试文档加载功能
   - 准备文本分割工具

4. **📝 训练数据扩展** (1小时)
   - 基于现有文档创建更多训练样本
   - 优化训练数据格式
   - 准备验证数据集

---

## ⏰ 时间安排建议

```bash
# 时间安排
echo "⏰ 模型下载期间工作安排建议："
echo ""
echo "第1阶段 (0-30分钟): 文档分析"
echo "  - 运行文档分析脚本"
echo "  - 了解文档结构"
echo "  - 识别处理难点"
echo ""
echo "第2阶段 (30-90分钟): 文档整理"
echo "  - 按类型分类文档"
echo "  - 创建标准目录"
echo "  - 处理重名文件"
echo ""
echo "第3阶段 (90-120分钟): 环境准备"
echo "  - 安装文档处理库"
echo "  - 测试加载功能"
echo "  - 准备处理工具"
echo ""
echo "第4阶段 (120-180分钟): 数据准备"
echo "  - 扩展训练数据"
echo "  - 优化数据格式"
echo "  - 准备验证集"
```

---

## �� 立即开始的建议

### **第一步：安装必要的库**
```bash
# 1. 先安装必要的库
pip install python-docx openpyxl python-pptx pandas

# 2. 验证安装
pip list | grep -E "(docx|openpyxl|pptx|pandas)"
```

### **第二步：运行文档分析**
```bash
# 1. 运行文档分析
python analyze_docs.py

# 2. 查看分析结果
cat docs_analysis.json | python -m json.tool

# 3. 根据分析结果决定下一步
```

### **第三步：文档整理**
```bash
# 1. 运行文档整理
python organize_docs.py

# 2. 查看整理结果
ls -la /root/autodl-tmp/enterprise_kb/organized_docs/

# 3. 检查整理记录
cat docs_organization.json | python -m json.tool
```

### **第四步：测试文档加载**
```bash
# 1. 测试文档加载器
python document_loader.py

# 2. 验证各种格式的加载
# 3. 处理加载错误
```

---

## �� 预期目录结构
